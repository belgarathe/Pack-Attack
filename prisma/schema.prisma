generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_DATABASE_URL")
}

model User {
  id                  String              @id @default(cuid())
  email               String              @unique
  name                String?
  passwordHash        String?             // Optional for OAuth users (Twitch)
  coins               Decimal             @db.Decimal(12, 2) @default(0)
  role                Role                @default(USER)
  isBot               Boolean             @default(false)
  emailVerified       Boolean             @default(false)
  verificationToken   String?             @unique
  verificationExpires DateTime?
  // Profile fields
  avatar              String?
  image               String?             // OAuth profile image (Twitch avatar)
  bio                 String?
  twitchUsername       String?             // Twitch display name for chat
  // Default shipping address
  shippingName        String?
  shippingAddress     String?
  shippingCity        String?
  shippingZip         String?
  shippingCountry     String?
  shippingPhone       String?
  // Relations
  accounts            Account[]           // OAuth accounts (Twitch, etc.)
  pulls               Pull[]
  transactions        Transaction[]
  sales               SaleHistory[]
  battlesCreated      Battle[]            @relation("BattleCreator")
  battlesWon          Battle[]            @relation("BattleWinner")
  battleParticipants  BattleParticipant[]
  cart                Cart?
  orders              Order[]
  emailsSent          EmailLog[]
  leaderboardEntries  BattleLeaderboard[]
  // Shop relations
  shop                Shop?
  shopOrders          ShopOrder[]
  shopCart            ShopCart?
  shopBoxOrders       ShopBoxOrder[]      // Orders from shop-created boxes
  // Achievement relations
  achievements        UserAchievement[]
  // Chat relations
  chatMessages        ChatMessage[]
  createdAt           DateTime            @default(now())
  updatedAt           DateTime            @updatedAt

  // PERFORMANCE: Indexes for common query patterns
  @@index([role])             // Admin queries filtering by role
  @@index([isBot])            // Bot filtering
  @@index([emailVerified])    // Email verification queries
}

// OAuth Account model (for Twitch and future OAuth providers)
model Account {
  id                String  @id @default(cuid())
  userId            String
  type              String
  provider          String
  providerAccountId String
  refresh_token     String? @db.Text
  access_token      String? @db.Text
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String? @db.Text
  session_state     String?
  user              User    @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
  @@index([userId])
}

// Global chat messages
model ChatMessage {
  id        String   @id @default(cuid())
  content   String   @db.VarChar(500)
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  createdAt DateTime @default(now())

  @@index([createdAt])
  @@index([userId])
}

model Box {
  id              String          @id @default(cuid())
  name            String
  description     String          @db.Text
  imageUrl        String
  price           Decimal         @db.Decimal(10, 2)
  cardsPerPack    Int
  games           CardGame[]      @default([MAGIC_THE_GATHERING])
  isActive        Boolean         @default(true)
  featured        Boolean         @default(false)
  popularity      Int             @default(0)
  // Shop owner who created this box (null = admin-created)
  createdByShopId String?
  createdByShop   Shop?           @relation(fields: [createdByShopId], references: [id], onDelete: SetNull)
  cards           Card[]
  pulls           Pull[]
  battles         Battle[]
  shopBoxOrders   ShopBoxOrder[]
  createdAt       DateTime        @default(now())
  updatedAt       DateTime        @updatedAt

  // PERFORMANCE: Indexes for common query patterns
  @@index([createdByShopId])
  @@index([isActive])
  @@index([featured])
  @@index([popularity])
  @@index([isActive, featured, popularity, createdAt])  // Box listing queries
}

model Card {
  id               String   @id @default(cuid())
  scryfallId       String
  name             String
  setName          String
  setCode          String
  collectorNumber  String
  rarity           String
  imageUrlGatherer String
  imageUrlScryfall String?
  colors           String[]
  type             String
  pullRate         Decimal  @db.Decimal(6, 3)
  coinValue        Decimal  @db.Decimal(10, 2) @default(1)
  sourceGame       CardGame @default(MAGIC_THE_GATHERING)
  boxId            String
  box              Box      @relation(fields: [boxId], references: [id], onDelete: Cascade)
  pulls            Pull[]
  createdAt        DateTime  @default(now())
  updatedAt        DateTime  @updatedAt

  @@unique([scryfallId, boxId])
  // PERFORMANCE: Indexes for common query patterns
  @@index([boxId])
  @@index([name])
  @@index([rarity])           // Rarity-based filtering
  @@index([sourceGame])       // Game filtering
  @@index([boxId, rarity])    // Combined box + rarity queries
  @@index([coinValue])        // Card value sorting
}

model Pull {
  id        String      @id @default(cuid())
  userId    String
  user      User        @relation(fields: [userId], references: [id])
  boxId     String
  box       Box         @relation(fields: [boxId], references: [id], onDelete: Cascade)
  cardId    String?
  card      Card?       @relation(fields: [cardId], references: [id], onDelete: SetNull)
  cardValue Decimal?    @db.Decimal(10, 2)
  timestamp DateTime    @default(now())
  battlePull BattlePull?
  cartItem  CartItem?

  // PERFORMANCE: Indexes for common query patterns
  @@index([userId])
  @@index([timestamp])
  @@index([userId, timestamp]) // User stats queries
  @@index([cardId])            // Card lookup queries
  @@index([boxId])             // Box-related queries
}

model Cart {
  id        String     @id @default(cuid())
  userId    String     @unique
  user      User       @relation(fields: [userId], references: [id], onDelete: Cascade)
  items     CartItem[]
  createdAt DateTime   @default(now())
  updatedAt DateTime   @updatedAt
}

model CartItem {
  id        String   @id @default(cuid())
  cartId    String
  cart      Cart     @relation(fields: [cartId], references: [id], onDelete: Cascade)
  pullId    String   @unique
  pull      Pull     @relation(fields: [pullId], references: [id], onDelete: Cascade)
  createdAt DateTime @default(now())

  @@index([cartId])
}

model Transaction {
  id              String        @id @default(cuid())
  userId          String
  user            User          @relation(fields: [userId], references: [id])
  amount          Decimal       @db.Decimal(10, 2)
  coins           Decimal       @db.Decimal(12, 2)
  paypalOrderId   String?       @unique
  paypalPayerId   String?
  stripePaymentId String?       @unique
  status          PaymentStatus
  timestamp       DateTime      @default(now())

  @@index([userId])
  @@index([paypalOrderId])
  @@index([status])                   // Payment status filtering
  @@index([timestamp])                // Date-range queries
  @@index([userId, status, timestamp]) // User transaction history
}

enum Role {
  USER
  ADMIN
  SHOP_OWNER
}

enum CardGame {
  MAGIC_THE_GATHERING
  ONE_PIECE
  POKEMON
  LORCANA
  YUGIOH
  FLESH_AND_BLOOD
}

enum PaymentStatus {
  PENDING
  COMPLETED
  FAILED
  REFUNDED
}

model Battle {
  id                String              @id @default(cuid())
  creatorId         String
  creator           User                @relation("BattleCreator", fields: [creatorId], references: [id])
  boxId             String
  box               Box                 @relation(fields: [boxId], references: [id], onDelete: Cascade)
  entryFee          Int                 @default(0)
  maxParticipants   Int                 @default(4)
  rounds            Int                 @default(1)
  battleMode        BattleMode          @default(NORMAL)
  shareMode         Boolean             @default(false)
  status            BattleStatus        @default(WAITING)
  winnerId          String?
  winner            User?               @relation("BattleWinner", fields: [winnerId], references: [id])
  totalPrize        Int                 @default(0)
  participants      BattleParticipant[]
  pulls             BattlePull[]
  createdAt         DateTime            @default(now())
  updatedAt         DateTime            @updatedAt
  startedAt         DateTime?
  finishedAt        DateTime?
  fullAt            DateTime?           // Timestamp when battle became full

  // PERFORMANCE: Indexes for common query patterns
  @@index([status])
  @@index([creatorId])
  @@index([battleMode])
  @@index([winnerId])              // Winner queries
  @@index([finishedAt])            // Leaderboard date range queries
  @@index([status, createdAt])     // Battle list queries
  @@index([winnerId, status])      // User win statistics
  @@index([status, finishedAt])    // Leaderboard queries
  @@index([status, fullAt])        // Auto-start queries
}

model BattleParticipant {
  id           String       @id @default(cuid())
  battleId     String
  battle       Battle       @relation(fields: [battleId], references: [id], onDelete: Cascade)
  userId       String
  user         User         @relation(fields: [userId], references: [id])
  totalValue   Int          @default(0)
  roundsPulled Int          @default(0)
  isReady      Boolean      @default(false)
  joinedAt     DateTime     @default(now())
  pulls        BattlePull[]

  @@unique([battleId, userId])
  @@index([battleId])
  @@index([userId])
  @@index([battleId, isReady])  // Battle start queries
}

model BattlePull {
  id            String            @id @default(cuid())
  battleId      String
  battle        Battle            @relation(fields: [battleId], references: [id], onDelete: Cascade)
  participantId String
  participant   BattleParticipant @relation(fields: [participantId], references: [id], onDelete: Cascade)
  pullId        String?           @unique
  pull          Pull?             @relation(fields: [pullId], references: [id])
  roundNumber   Int
  coinValue     Decimal           @db.Decimal(10, 2)
  pulledAt      DateTime          @default(now())
  itemName      String?
  itemImage     String?
  itemRarity    String?

  @@index([battleId])
  @@index([participantId])
  @@index([battleId, roundNumber])
}

enum BattleStatus {
  WAITING
  COUNTDOWN
  IN_PROGRESS
  FINISHED
  CANCELLED
}

enum BattleMode {
  NORMAL
  UPSIDE_DOWN
  JACKPOT
}

model SaleHistory {
  id            String   @id @default(cuid())
  userId        String
  user          User     @relation(fields: [userId], references: [id])
  cardId        String?
  cardName      String
  cardImage     String?
  coinsReceived Decimal       @db.Decimal(10, 2)
  timestamp     DateTime @default(now())

  @@index([userId])
  @@index([timestamp])
}

model EmailLog {
  id        String      @id @default(cuid())
  userId    String?
  user      User?       @relation(fields: [userId], references: [id], onDelete: SetNull)
  toEmail   String
  subject   String
  type      EmailType
  status    EmailStatus @default(SENT)
  resendId  String?
  error     String?
  sentAt    DateTime    @default(now())

  @@index([userId])
  @@index([toEmail])
  @@index([type])
  @@index([sentAt])
}

enum EmailType {
  VERIFICATION
  PASSWORD_RESET
  WELCOME
  NOTIFICATION
  ADMIN_CUSTOM
}

enum EmailStatus {
  SENT
  DELIVERED
  FAILED
  BOUNCED
}

model Order {
  id              String              @id @default(cuid())
  userId          String
  user            User                @relation(fields: [userId], references: [id])
  status          OrderStatus         @default(PENDING)
  totalCoins      Decimal             @db.Decimal(10, 2)
  shippingName    String
  shippingEmail   String
  shippingAddress String
  shippingCity    String
  shippingZip     String
  shippingCountry String
  shippingMethod  ShippingPaymentMethod @default(COINS)
  shippingCost    Decimal             @db.Decimal(10, 2) @default(5.00)
  notes           String?
  // Shop assignment - admin can assign order to a shop for fulfillment
  assignedShopId  String?
  assignedShop    Shop?               @relation(fields: [assignedShopId], references: [id], onDelete: SetNull)
  assignedAt      DateTime?
  // Tracking info (can be filled by shop or admin)
  trackingNumber  String?
  trackingUrl     String?
  shopNotes       String?             // Notes from the assigned shop
  items           OrderItem[]
  createdAt       DateTime            @default(now())
  updatedAt       DateTime            @updatedAt

  // PERFORMANCE: Indexes for common query patterns
  @@index([userId])
  @@index([status])
  @@index([assignedShopId])
  @@index([userId, status])        // User order filtering
  @@index([createdAt])             // Date-based queries
  @@index([assignedShopId, status]) // Shop order filtering
}

enum ShippingPaymentMethod {
  COINS
  EUROS
}

model OrderItem {
  id        String   @id @default(cuid())
  orderId   String
  order     Order    @relation(fields: [orderId], references: [id], onDelete: Cascade)
  cardName  String
  cardImage String?
  coinValue Decimal  @db.Decimal(10, 2)
  createdAt DateTime @default(now())

  @@index([orderId])
}

enum OrderStatus {
  PENDING
  PROCESSING
  SHIPPED
  DELIVERED
  CANCELLED
}

model BattleLeaderboard {
  id              String   @id @default(cuid())
  userId          String
  user            User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  month           Int      // 1-12
  year            Int      // e.g., 2026
  points          Int      @default(0)
  battlesWon      Int      @default(0)
  battlesPlayed   Int      @default(0)
  totalCoinsWon   Decimal  @db.Decimal(12, 2) @default(0)
  prizeAwarded    Boolean  @default(false)
  prizeAmount     Decimal  @db.Decimal(10, 2) @default(0)
  rank            Int?
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@unique([userId, month, year])
  @@index([month, year])
  @@index([points])
}

// ============================================
// WEBSHOP MODELS
// ============================================

model Shop {
  id              String        @id @default(cuid())
  ownerId         String        @unique
  owner           User          @relation(fields: [ownerId], references: [id], onDelete: Cascade)
  name            String
  description     String?       @db.Text
  logo            String?
  banner          String?
  isActive        Boolean       @default(true)
  products        ShopProduct[]
  orders          ShopOrder[]
  boxes           Box[]
  boxOrders       ShopBoxOrder[]
  assignedOrders  Order[]       // Regular orders assigned to this shop by admin
  createdAt       DateTime      @default(now())
  updatedAt       DateTime      @updatedAt

  @@index([isActive])
}

model ShopProduct {
  id            String          @id @default(cuid())
  shopId        String
  shop          Shop            @relation(fields: [shopId], references: [id], onDelete: Cascade)
  name          String
  description   String?         @db.Text
  price         Decimal         @db.Decimal(10, 2)
  comparePrice  Decimal?        @db.Decimal(10, 2) // Original price for showing discounts
  images        String[]        // Array of image URLs
  category      ProductCategory
  game          CardGame?       // Which TCG this product belongs to
  condition     CardCondition   @default(NEAR_MINT)
  stock         Int             @default(0)
  sku           String?
  isActive      Boolean         @default(true)
  featured      Boolean         @default(false)
  cartItems     ShopCartItem[]
  orderItems    ShopOrderItem[]
  createdAt     DateTime        @default(now())
  updatedAt     DateTime        @updatedAt

  @@index([shopId])
  @@index([category])
  @@index([game])
  @@index([isActive])
  @@index([featured])
  @@index([shopId, isActive, featured])  // Shop product filtering
}

enum ProductCategory {
  SINGLE_CARD
  BOOSTER_BOX
  BOOSTER_PACK
  STARTER_DECK
  STRUCTURE_DECK
  ACCESSORIES
  SLEEVES
  PLAYMAT
  BINDER
  DECK_BOX
  OTHER
}

enum CardCondition {
  MINT
  NEAR_MINT
  EXCELLENT
  GOOD
  LIGHT_PLAYED
  PLAYED
  POOR
}

model ShopCart {
  id        String         @id @default(cuid())
  userId    String         @unique
  user      User           @relation(fields: [userId], references: [id], onDelete: Cascade)
  items     ShopCartItem[]
  createdAt DateTime       @default(now())
  updatedAt DateTime       @updatedAt
}

model ShopCartItem {
  id        String      @id @default(cuid())
  cartId    String
  cart      ShopCart    @relation(fields: [cartId], references: [id], onDelete: Cascade)
  productId String
  product   ShopProduct @relation(fields: [productId], references: [id], onDelete: Cascade)
  quantity  Int         @default(1)
  createdAt DateTime    @default(now())

  @@unique([cartId, productId])
  @@index([cartId])
  @@index([productId])
}

model ShopOrder {
  id              String          @id @default(cuid())
  orderNumber     String          @unique @default(cuid())
  userId          String
  user            User            @relation(fields: [userId], references: [id])
  shopId          String
  shop            Shop            @relation(fields: [shopId], references: [id])
  status          ShopOrderStatus @default(PENDING)
  subtotal        Decimal         @db.Decimal(10, 2)
  shippingCost    Decimal         @db.Decimal(10, 2) @default(0)
  total           Decimal         @db.Decimal(10, 2)
  // Shipping info
  shippingName    String
  shippingEmail   String
  shippingAddress String
  shippingCity    String
  shippingZip     String
  shippingCountry String
  shippingPhone   String?
  // Payment info
  paymentMethod   String?
  paymentId       String?
  paidAt          DateTime?
  // Tracking
  trackingNumber  String?
  trackingUrl     String?
  notes           String?
  items           ShopOrderItem[]
  createdAt       DateTime        @default(now())
  updatedAt       DateTime        @updatedAt

  @@index([userId])
  @@index([shopId])
  @@index([status])
  @@index([orderNumber])
  @@index([shopId, status, createdAt])  // Shop dashboard queries
}

model ShopOrderItem {
  id          String      @id @default(cuid())
  orderId     String
  order       ShopOrder   @relation(fields: [orderId], references: [id], onDelete: Cascade)
  productId   String
  product     ShopProduct @relation(fields: [productId], references: [id])
  productName String      // Snapshot of product name at time of order
  productImage String?    // Snapshot of product image
  price       Decimal     @db.Decimal(10, 2) // Price at time of order
  quantity    Int
  createdAt   DateTime    @default(now())

  @@index([orderId])
  @@index([productId])
}

enum ShopOrderStatus {
  PENDING
  PAID
  PROCESSING
  SHIPPED
  DELIVERED
  CANCELLED
  REFUNDED
}

// ============================================
// SHOP BOX ORDERS - Orders from shop-created boxes
// ============================================

model ShopBoxOrder {
  id              String              @id @default(cuid())
  orderNumber     String              @unique @default(cuid())
  // The shop that created the box (fulfills the order)
  shopId          String
  shop            Shop                @relation(fields: [shopId], references: [id])
  // The box that was opened
  boxId           String
  box             Box                 @relation(fields: [boxId], references: [id])
  // The user who placed the order
  userId          String
  user            User                @relation(fields: [userId], references: [id])
  status          ShopBoxOrderStatus  @default(PENDING)
  // Card details (snapshot at order time)
  cardName        String
  cardImage       String?
  cardValue       Decimal             @db.Decimal(10, 2)
  cardRarity      String?
  // Shipping info
  shippingName    String
  shippingEmail   String
  shippingAddress String
  shippingCity    String
  shippingZip     String
  shippingCountry String
  shippingPhone   String?
  shippingMethod  ShippingPaymentMethod @default(COINS)
  shippingCost    Decimal             @db.Decimal(10, 2) @default(5.00)
  // Tracking
  trackingNumber  String?
  trackingUrl     String?
  notes           String?
  shopNotes       String?             // Internal notes from shop
  createdAt       DateTime            @default(now())
  updatedAt       DateTime            @updatedAt

  @@index([shopId])
  @@index([userId])
  @@index([boxId])
  @@index([status])
  @@index([orderNumber])
  @@index([shopId, status, createdAt])  // Shop dashboard queries
}

enum ShopBoxOrderStatus {
  PENDING
  CONFIRMED
  PROCESSING
  SHIPPED
  DELIVERED
  CANCELLED
}

// BOX PRESETS - Templates for quick box creation
// ============================================

model BoxPreset {
  id              String     @id @default(cuid())
  name            String
  description     String?    @db.Text
  
  // Box configuration snapshot
  boxName         String
  boxDescription  String     @db.Text
  price           Decimal    @db.Decimal(10, 2)
  cardsPerPack    Int
  games           CardGame[]
  
  // Cards configuration stored as JSON
  // Array of: { scryfallId, name, setName, setCode, collectorNumber, rarity, imageUrl, pullRate, coinValue, sourceGame }
  cardsConfig     Json
  
  // Preview images
  thumbnailUrl    String?    // Main preview image (highest value card)
  previewImages   String[]   // Array of card images for gallery preview
  
  // Metadata
  cardCount       Int        @default(0)
  totalPullRate   Decimal    @db.Decimal(6, 3) @default(100)
  
  // Shared among all admins
  createdAt       DateTime   @default(now())
  updatedAt       DateTime   @updatedAt

  @@index([name])
  @@index([createdAt])
}

// ============================================
// ACHIEVEMENT SYSTEM
// ============================================

model Achievement {
  id              String            @id @default(cuid())
  code            String            @unique // Unique identifier like "FIRST_PULL", "BATTLE_MASTER"
  name            String
  description     String
  category        AchievementCategory
  icon            String            // Icon name from lucide-react
  rarity          AchievementRarity @default(COMMON)
  requirement     Int               // Number needed to unlock (e.g., 10 pulls)
  coinReward      Decimal           @db.Decimal(10, 2) @default(0)
  isSecret        Boolean           @default(false) // Hidden until unlocked
  sortOrder       Int               @default(0)
  isActive        Boolean           @default(true)
  userAchievements UserAchievement[]
  createdAt       DateTime          @default(now())
  updatedAt       DateTime          @updatedAt

  @@index([category])
  @@index([rarity])
  @@index([isActive])
}

model UserAchievement {
  id            String      @id @default(cuid())
  userId        String
  user          User        @relation(fields: [userId], references: [id], onDelete: Cascade)
  achievementId String
  achievement   Achievement @relation(fields: [achievementId], references: [id], onDelete: Cascade)
  progress      Int         @default(0) // Current progress towards requirement
  unlockedAt    DateTime?   // Null if not yet unlocked
  rewardClaimed Boolean     @default(false)
  createdAt     DateTime    @default(now())
  updatedAt     DateTime    @updatedAt

  @@unique([userId, achievementId])
  @@index([userId])
  @@index([achievementId])
  @@index([unlockedAt])
}

enum AchievementCategory {
  PULLS       // Pack opening achievements
  BATTLES     // Battle-related achievements
  COLLECTION  // Collection milestones
  ECONOMY     // Coins/sales achievements
  SOCIAL      // Community achievements
  SPECIAL     // Limited/event achievements
}

enum AchievementRarity {
  COMMON      // Easy to get
  UNCOMMON    // Moderate effort
  RARE        // Significant effort
  EPIC        // Hard to achieve
  LEGENDARY   // Extremely difficult
}
