---
description: Pack Attack production server SSH keys, deployment, and infrastructure. ALWAYS READ THIS BEFORE ANY SERVER OR DEPLOYMENT TASK.
alwaysApply: true
---

# Pack Attack Server Infrastructure

## CRITICAL: SSH Key Location

| Item | Value |
|------|-------|
| **PRIVATE KEY** | `C:\Users\tim\.ssh\packattack-server` |
| **PUBLIC KEY** | `C:\Users\tim\.ssh\packattack-server.pub` |
| **Key Type** | ED25519 |
| **Key Fingerprint** | `SHA256:Z4jsudDiI1ZtyiGwQzwIRbFEU52oOt48aCV0jRBOmrQ` |
| **Key Comment** | `packattack-server-deploy-2026-02-09` |
| **Created** | February 9, 2026 |

### PUBLIC KEY (for adding to servers)
```
ssh-ed25519 AAAAC3NzaC1lZDI1NTE5AAAAIKNvuPdMybMnoJzFUqW9jxsFo3PtY87hnBOwJN+P3Ih0 packattack-server-deploy-2026-02-09
```

### ABSOLUTE RULES - NEVER BREAK THESE
1. **NEVER delete, rename, move, or modify** the SSH key files
2. **NEVER overwrite** the private key with a public key or any other content
3. **NEVER run "security audits"** that touch SSH key files
4. **NEVER change permissions** on the SSH key files
5. **ALWAYS use `-i` flag** with the exact path when SSHing: `ssh -i C:\Users\tim\.ssh\packattack-server`
6. If SSH fails, **CHECK THE KEY FILE EXISTS AND IS 432 BYTES** before doing anything else

---

## Server Connection

| Property | Value |
|----------|-------|
| **Server IP** | `82.165.66.236` |
| **Domain** | `pack-attack.de` |
| **Hosting** | Strato |
| **OS** | Ubuntu 24.04.3 LTS |
| **SSH User (root)** | `root` |
| **SSH User (app)** | `packattack` |
| **App Directory** | `/var/www/packattack/app` |

### SSH Commands

```powershell
# Connect as root (from Windows PowerShell)
ssh -i "$env:USERPROFILE\.ssh\packattack-server" root@82.165.66.236

# Connect as packattack user
ssh -i "$env:USERPROFILE\.ssh\packattack-server" packattack@82.165.66.236
```

---

## Deployment

### Quick Deploy (from local machine)
```powershell
ssh -i "$env:USERPROFILE\.ssh\packattack-server" root@82.165.66.236 "cd /var/www/packattack/app && git pull origin main && npm ci && npx prisma generate && npm run build && pm2 reload packattack --update-env && pm2 status"
```

### On-Server Deploy
```bash
cd /var/www/packattack/app
sudo -u packattack git fetch origin main
sudo -u packattack git reset --hard origin/main
sudo -u packattack npm ci --production=false
sudo -u packattack npx prisma generate
sudo -u packattack npx prisma db push --accept-data-loss
sudo -u packattack npm run build
sudo -u packattack pm2 reload packattack --update-env
```

### Health Check
```bash
curl https://pack-attack.de/api/health
```

---

## Application Management (PM2)

```bash
pm2 status                          # View status
pm2 logs packattack                 # View logs
pm2 reload packattack --update-env  # Reload (zero-downtime)
pm2 restart packattack              # Hard restart
pm2 monit                           # Monitor
```

---

## Database

| Property | Value |
|----------|-------|
| **Provider** | Neon PostgreSQL |
| **Host** | `ep-patient-resonance-ahmtm2jq-pooler.c-3.us-east-1.aws.neon.tech` |
| **Database** | `neondb` |
| **SSL** | Required |

---

## File Locations

| Path | Description |
|------|-------------|
| `/var/www/packattack/app` | Application root |
| `/var/www/packattack/app/.env` | Environment config |
| `/var/log/packattack/` | Application logs |
| `/var/log/pm2/` | PM2 logs |
| `/etc/nginx/sites-available/packattack` | Nginx config |

---

## API Keys & Secrets Policy

### ABSOLUTE RULE: NEVER hardcode API keys, secrets, passwords, or tokens in code or config files that get committed to git.

ALL secrets must be stored in:
1. **GitHub Secrets** (for CI/CD workflows) -- `https://github.com/belgarathe/Pack-Attack/settings/secrets/actions`
2. **Server `.env` file** (`/var/www/packattack/app/.env`) -- set directly on server, never committed
3. **Local `.env.local`** -- gitignored, never committed

### Known Secrets (stored in GitHub Secrets + server .env)

| Secret Name | Purpose | Where Used |
|-------------|---------|------------|
| `JUSTTCG_API_KEY` | Card search API | Server .env + GitHub Secret |
| `RESEND_API_KEY` | Email sending | Server .env |
| `NEXTAUTH_SECRET` | Session encryption | Server .env |
| `DATABASE_URL` | Neon PostgreSQL | Server .env |
| `TWITCH_CLIENT_ID` | Twitch OAuth for chat | Server .env + GitHub Secret |
| `TWITCH_CLIENT_SECRET` | Twitch OAuth for chat | Server .env + GitHub Secret |
| `SERVER_IP` | Deployment target | GitHub Secret |
| `SSH_PRIVATE_KEY` | Deployment SSH key | GitHub Secret |

### In GitHub Actions workflows, ALWAYS reference secrets like:
```yaml
${{ secrets.JUSTTCG_API_KEY }}
${{ secrets.TWITCH_CLIENT_ID }}
```

### NEVER do this:
```yaml
# BAD - hardcoded secret
JUSTTCG_API_KEY=tcg_abc123
# BAD - secret in curl/sed commands
sed -i 's|KEY=.*|KEY=actual_secret_value|' .env
```
